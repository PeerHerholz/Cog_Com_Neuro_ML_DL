
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Using Python for neuroimaging data - NiBabel &#8212; Spring term 2022</title>
    
  <link href="../../../_static/css/theme.css" rel="stylesheet">
  <link href="../../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/togglebutton.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Morphometric analyzes" href="morphometry.html" />
    <link rel="prev" title="Magnetic Resonance Imaging (MRI)" href="mri_intro.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../../_static/cog_com_neuro_ml_dl_logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Spring term 2022</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../index.html">
   Welcome!
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../dei.html">
   Diversity, Equity and Inclusion
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../overview.html">
   Course overview &amp; procedure
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../outline.html">
   General outline
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../setup.html">
   Setup for the course
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../../pages/introduction.html">
   Introduction
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="../../pages/introduction_1.html">
     Introduction I - General introduction
    </a>
   </li>
   <li class="toctree-l2 current active has-children">
    <a class="reference internal" href="../../pages/introduction_2.html">
     Introduction II - Neuroscience
    </a>
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
    <label for="toctree-checkbox-2">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="current">
     <li class="toctree-l3">
      <a class="reference internal" href="cortical_maps.html">
       Cortical maps
      </a>
     </li>
     <li class="toctree-l3 current active has-children">
      <a class="reference internal" href="mri_intro.html">
       Magnetic Resonance Imaging (MRI)
      </a>
      <input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
      <label for="toctree-checkbox-3">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul class="current">
       <li class="toctree-l4 current active">
        <a class="current reference internal" href="#">
         Using Python for neuroimaging data - NiBabel
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="morphometry.html">
       Morphometric analyzes
      </a>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="dMRI_intro.html">
       Diffusion MRI
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
      <label for="toctree-checkbox-4">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="diffusion_imaging.html">
         Structural connectivity and diffusion imaging
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="fmri_intro.html">
       Functional MRI
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
      <label for="toctree-checkbox-5">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="image_manipulation_nilearn.html">
         Using Python for neuroimaging data - Nilearn
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="statistical_maps.html">
       Statistical maps
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
      <label for="toctree-checkbox-6">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="statistical_analyses_MRI.html">
         Nilearn GLM: statistical analyses of MRI in Python
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="connectivity_intro.html">
       Functional connectivity
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
      <label for="toctree-checkbox-7">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="functional_connectivity.html">
         Functional connectivity and resting state
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="eeg_introduction.html">
       Electroencephalography
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
      <label for="toctree-checkbox-8">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="mne_introduction.html">
         MNE python for EEG analysis
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="mne_preprocessing.html">
         EEG preprocessing with MNE
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="mne_erp.html">
         Evoked potentials/ERPs with MNE
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="mne_workflow_tutorial.html">
         MNE Workflow tutorial
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../pages/introduction_3.html">
     Introduction III - NeuroDataScience
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
    <label for="toctree-checkbox-9">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../pages/neurodata/replicability_open_science.html">
       Replicability crisis, open science &amp; pre-registration
      </a>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../pages/neurodata/data_management.html">
       Project &amp; data management
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
      <label for="toctree-checkbox-10">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../neurodata/pybids.html">
         Introduction to
         <code class="docutils literal notranslate">
          <span class="pre">
           pybids
          </span>
         </code>
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../pages/neurodata/version_control_general.html">
       Version control
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
      <label for="toctree-checkbox-11">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../neurodata/version_control.html">
         Introduction to git and github
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../pages/neurodata/literature.html">
       Finding &amp; organizing literature
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../pages/neurodata/project_101.html">
       Connecting the dots
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../pages/introduction_4.html">
     Introduction IV - Linear Algebra
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
    <label for="toctree-checkbox-12">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../linear_algebra/LinearAlgebra.html">
       Linear Algebra
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
      <label for="toctree-checkbox-13">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul class="simple">
      </ul>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../pages/introduction_5.html">
     Introduction V - Artificial Intelligence
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
    <label for="toctree-checkbox-14">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../artificial_intelligence/terms_definitions.html">
       Models, AI and all other buzz words
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../artificial_intelligence/ML_intro.html">
       Supervised or unsupervised &amp; model types
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../projects.html">
   Student projects
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../break.html">
   Yoga and/or dance break
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../questionnaires.html">
   Questionnaire templates
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../CoC.html">
   Code of Conduct
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../../_sources/introduction/notebooks/neuroscience/image_manipulation_nibabel.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/PeerHerholz/Cog_Com_Neuro_ML_DL"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/PeerHerholz/Cog_Com_Neuro_ML_DL/issues/new?title=Issue%20on%20page%20%2Fintroduction/notebooks/neuroscience/image_manipulation_nibabel.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/PeerHerholz/Cog_Com_Neuro_ML_DL/edit/main/lecture/introduction/notebooks/neuroscience/image_manipulation_nibabel.ipynb"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/PeerHerholz/Cog_Com_Neuro_ML_DL/main?urlpath=tree/lecture/introduction/notebooks/neuroscience/image_manipulation_nibabel.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Using Python for neuroimaging data - NiBabel
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#nibabel">
   Nibabel
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setup">
     Setup
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loading-and-inspecting-images-in-nibabel">
     Loading and inspecting images in
     <code class="docutils literal notranslate">
      <span class="pre">
       nibabel
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#accessing-specific-parameters">
       Accessing specific parameters
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#notes-on-working-with-neuroimaging-and-memory-allocation">
         Notes on working with neuroimaging and memory allocation
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#what-s-actually-in-the-neuroimaging-data">
       What’s actually in the
       <code class="docutils literal notranslate">
        <span class="pre">
         neuroimaging
        </span>
       </code>
       <code class="docutils literal notranslate">
        <span class="pre">
         data
        </span>
       </code>
       ?
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#practical-exercise-1">
       Practical exercise 1:
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#visually-inspecting-images-via-orthoview">
       Visually inspecting
       <code class="docutils literal notranslate">
        <span class="pre">
         images
        </span>
       </code>
       via
       <code class="docutils literal notranslate">
        <span class="pre">
         orthoview()
        </span>
       </code>
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#sidenote-on-plotting-with-orthoview">
         Sidenote on plotting with
         <code class="docutils literal notranslate">
          <span class="pre">
           orthoview()
          </span>
         </code>
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#header">
       Header
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#affine">
       Affine
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#nib-ls">
     <code class="docutils literal notranslate">
      <span class="pre">
       nib-ls
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-and-saving-images">
     Creating and saving images
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusions">
   Conclusions
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Using Python for neuroimaging data - NiBabel</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Using Python for neuroimaging data - NiBabel
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#nibabel">
   Nibabel
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setup">
     Setup
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loading-and-inspecting-images-in-nibabel">
     Loading and inspecting images in
     <code class="docutils literal notranslate">
      <span class="pre">
       nibabel
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#accessing-specific-parameters">
       Accessing specific parameters
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#notes-on-working-with-neuroimaging-and-memory-allocation">
         Notes on working with neuroimaging and memory allocation
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#what-s-actually-in-the-neuroimaging-data">
       What’s actually in the
       <code class="docutils literal notranslate">
        <span class="pre">
         neuroimaging
        </span>
       </code>
       <code class="docutils literal notranslate">
        <span class="pre">
         data
        </span>
       </code>
       ?
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#practical-exercise-1">
       Practical exercise 1:
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#visually-inspecting-images-via-orthoview">
       Visually inspecting
       <code class="docutils literal notranslate">
        <span class="pre">
         images
        </span>
       </code>
       via
       <code class="docutils literal notranslate">
        <span class="pre">
         orthoview()
        </span>
       </code>
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#sidenote-on-plotting-with-orthoview">
         Sidenote on plotting with
         <code class="docutils literal notranslate">
          <span class="pre">
           orthoview()
          </span>
         </code>
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#header">
       Header
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#affine">
       Affine
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#nib-ls">
     <code class="docutils literal notranslate">
      <span class="pre">
       nib-ls
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-and-saving-images">
     Creating and saving images
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusions">
   Conclusions
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="section" id="using-python-for-neuroimaging-data-nibabel">
<h1>Using Python for neuroimaging data - <a class="reference external" href="https://nipy.org/nibabel/">NiBabel</a><a class="headerlink" href="#using-python-for-neuroimaging-data-nibabel" title="Permalink to this headline">¶</a></h1>
<p>The primary goal of this section is to become familiar with <code class="docutils literal notranslate"><span class="pre">loading</span></code>, <code class="docutils literal notranslate"><span class="pre">modifying</span></code>, <code class="docutils literal notranslate"><span class="pre">saving</span></code>, and <code class="docutils literal notranslate"><span class="pre">visualizing</span></code> <code class="docutils literal notranslate"><span class="pre">neuroimages</span></code> in <code class="docutils literal notranslate"><span class="pre">Python</span></code>. A secondary goal is to develop a conceptual understanding of the <code class="docutils literal notranslate"><span class="pre">data</span> <span class="pre">structures</span></code> involved, to facilitate diagnosing problems in <code class="docutils literal notranslate"><span class="pre">data</span></code> or <code class="docutils literal notranslate"><span class="pre">analysis</span></code> <code class="docutils literal notranslate"><span class="pre">pipelines</span></code>.</p>
<p>To these ends, we’ll be exploring the core <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">library</span></code> for <code class="docutils literal notranslate"><span class="pre">handling</span></code> and <code class="docutils literal notranslate"><span class="pre">wrangling</span></code> <code class="docutils literal notranslate"><span class="pre">neuroimaging</span></code> <code class="docutils literal notranslate"><span class="pre">data</span></code>: <span class="xref myst">nibabel</span>. While this short introduction should get you started, it is well worth your time to look through <code class="docutils literal notranslate"><span class="pre">nibabel's</span></code> excellent <a class="reference external" href="http://nipy.org/nibabel/">documentation</a>.</p>
</div>
<div class="section" id="nibabel">
<h1><a class="reference external" href="https://nipy.org/nibabel/">Nibabel</a><a class="headerlink" href="#nibabel" title="Permalink to this headline">¶</a></h1>
<p><img alt="" src="https://nipy.org/nibabel/_static/nibabel-logo.svg" /></p>
<p><code class="docutils literal notranslate"><span class="pre">Nibabel</span></code> is a low-level <code class="docutils literal notranslate"><span class="pre">Python</span> <span class="pre">library</span></code> that gives access to a variety of <code class="docutils literal notranslate"><span class="pre">imaging</span></code> <code class="docutils literal notranslate"><span class="pre">formats</span></code>, with a particular focus on providing a common interface to the various <strong>volumetric</strong> formats produced by <code class="docutils literal notranslate"><span class="pre">MRI</span> <span class="pre">scanners</span></code> and used in common <code class="docutils literal notranslate"><span class="pre">neuroimaging</span></code> toolkits such as <a class="reference external" href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/">FSL</a>, <a class="reference external" href="https://afni.nimh.nih.gov/">AFNI</a>, <a class="reference external" href="https://surfer.nmr.mgh.harvard.edu/">FreeSurfer</a> and <a class="reference external" href="https://www.fil.ion.ucl.ac.uk/spm/">SPM</a>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">NIfTI-1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NIfTI-2</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SPM</span> <span class="pre">Analyze</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FreeSurfer</span></code> <code class="docutils literal notranslate"><span class="pre">.mgh</span></code>/<code class="docutils literal notranslate"><span class="pre">.mgz</span></code> files</p></li>
<li><p>Philips <code class="docutils literal notranslate"><span class="pre">PAR/REC</span></code></p></li>
<li><p>Siemens <code class="docutils literal notranslate"><span class="pre">ECAT</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DICOM</span></code> (limited support)</p></li>
</ul>
<p>It also supports <strong>surface</strong> file formats:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">GIFTI</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FreeSurfer</span></code> <code class="docutils literal notranslate"><span class="pre">surfaces</span></code>, <code class="docutils literal notranslate"><span class="pre">labels</span></code> and <code class="docutils literal notranslate"><span class="pre">annotations</span></code></p></li>
</ul>
<p>and others such as:</p>
<p><strong>Connectivity</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CIFTI-2</span></code></p></li>
</ul>
<p><strong>Tractography</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">TrackViz</span></code> <code class="docutils literal notranslate"><span class="pre">.trk</span></code> files</p></li>
</ul>
<p>as well as a number of related <code class="docutils literal notranslate"><span class="pre">formats</span></code>.</p>
<p><strong>Note:</strong> Almost all of these can be <code class="docutils literal notranslate"><span class="pre">loaded</span></code> through the <a class="reference external" href="https://nipy.org/nibabel/reference/nibabel.loadsave.html#nibabel.loadsave.load">nibabel.load</a> <code class="docutils literal notranslate"><span class="pre">interface</span></code>.</p>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<p>Before we actually start, we are going to need to <code class="docutils literal notranslate"><span class="pre">import</span></code> the <code class="docutils literal notranslate"><span class="pre">nibabel</span></code> <code class="docutils literal notranslate"><span class="pre">library</span></code> and a few others, more or less related to <code class="docutils literal notranslate"><span class="pre">basic</span> <span class="pre">computing</span></code> and <code class="docutils literal notranslate"><span class="pre">plotting</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nilearn</span> <span class="kn">import</span> <span class="n">plotting</span>
<span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nb</span>
</pre></div>
</div>
</div>
</div>
<p>Great, let’s get started.</p>
</div>
<div class="section" id="loading-and-inspecting-images-in-nibabel">
<h2>Loading and inspecting images in <code class="docutils literal notranslate"><span class="pre">nibabel</span></code><a class="headerlink" href="#loading-and-inspecting-images-in-nibabel" title="Permalink to this headline">¶</a></h2>
<p>At first, we are going to explore how we can <code class="docutils literal notranslate"><span class="pre">load</span></code> and <code class="docutils literal notranslate"><span class="pre">inspect</span></code> <code class="docutils literal notranslate"><span class="pre">neuroimages</span></code> in <code class="docutils literal notranslate"><span class="pre">nibabel</span></code>. To this end, we will use parts of the <code class="docutils literal notranslate"><span class="pre">tutorial</span> <span class="pre">datasets</span></code> you should’ve <a class="reference external" href="https://peerherholz.github.io/Cog_Com_Neuro_ML_DL/setup.html#getting-the-course-content">downloaded during the course setup</a>. Specifically, we are going to have a closer look at a <code class="docutils literal notranslate"><span class="pre">functional</span> <span class="pre">MRI</span></code> of <code class="docutils literal notranslate"><span class="pre">sub-01</span></code>. As mentioned before, basically all <code class="docutils literal notranslate"><span class="pre">file</span> <span class="pre">formats</span></code> are accessible via the <code class="docutils literal notranslate"><span class="pre">nibabel</span> <span class="pre">load</span></code> <code class="docutils literal notranslate"><span class="pre">interface</span></code>. All we need to do is to provide the <code class="docutils literal notranslate"><span class="pre">path</span></code> to the file we want to <code class="docutils literal notranslate"><span class="pre">load</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;/data/ds000114/sub-01/ses-test/func/sub-01_ses-test_task-fingerfootlips_bold.nii.gz&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>That’s all it takes and with that, we can directly inspect our now <code class="docutils literal notranslate"><span class="pre">loaded</span></code> <code class="docutils literal notranslate"><span class="pre">fMRI</span></code> <code class="docutils literal notranslate"><span class="pre">image</span></code>, for example via <code class="docutils literal notranslate"><span class="pre">print</span></code> which will give is the information stored in the <code class="docutils literal notranslate"><span class="pre">header</span></code> of the <code class="docutils literal notranslate"><span class="pre">image</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;nibabel.nifti1.Nifti1Image&#39;&gt;
data shape (64, 64, 30, 184)
affine: 
[[-3.99471426e+00 -2.04233140e-01  2.29353290e-02  1.30641693e+02]
 [-2.05448717e-01  3.98260689e+00 -3.10890853e-01 -9.74732285e+01]
 [ 6.95819734e-03  3.11659902e-01  3.98780894e+00 -8.06465759e+01]
 [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  1.00000000e+00]]
metadata:
&lt;class &#39;nibabel.nifti1.Nifti1Header&#39;&gt; object, endian=&#39;&lt;&#39;
sizeof_hdr      : 348
data_type       : b&#39;&#39;
db_name         : b&#39;?TR:2500.000 TE:50&#39;
extents         : 0
session_error   : 0
regular         : b&#39;r&#39;
dim_info        : 0
dim             : [  4  64  64  30 184   1   1   1]
intent_p1       : 0.0
intent_p2       : 0.0
intent_p3       : 0.0
intent_code     : none
datatype        : int16
bitpix          : 16
slice_start     : 0
pixdim          : [-1.        4.        4.        3.999975  2.5       1.        1.
  1.      ]
vox_offset      : 0.0
scl_slope       : nan
scl_inter       : nan
slice_end       : 0
slice_code      : unknown
xyzt_units      : 10
cal_max         : 0.0
cal_min         : 0.0
slice_duration  : 0.0
toffset         : 0.0
glmax           : 255
glmin           : 0
descrip         : b&#39;&#39;
aux_file        : b&#39;&#39;
qform_code      : scanner
sform_code      : scanner
quatern_b       : 0.025633048
quatern_c       : -0.9989105
quatern_d       : -0.03895198
qoffset_x       : 130.6417
qoffset_y       : -97.47323
qoffset_z       : -80.646576
srow_x          : [-3.9947143e+00 -2.0423314e-01  2.2935329e-02  1.3064169e+02]
srow_y          : [ -0.20544872   3.982607    -0.31089085 -97.47323   ]
srow_z          : [ 6.9581973e-03  3.1165990e-01  3.9878089e+00 -8.0646576e+01]
intent_name     : b&#39;&#39;
magic           : b&#39;n+1&#39;
</pre></div>
</div>
</div>
</div>
<p>This <code class="docutils literal notranslate"><span class="pre">data-affine-header</span> <span class="pre">structure</span></code> is common to <code class="docutils literal notranslate"><span class="pre">volumetric</span></code> <code class="docutils literal notranslate"><span class="pre">formats</span></code> in <code class="docutils literal notranslate"><span class="pre">nibabel</span></code>, though the details of the <code class="docutils literal notranslate"><span class="pre">header</span></code> will vary from <code class="docutils literal notranslate"><span class="pre">format</span></code> to <code class="docutils literal notranslate"><span class="pre">format</span></code>. As you can see above, the here utilized example entails <code class="docutils literal notranslate"><span class="pre">information</span></code> about the <code class="docutils literal notranslate"><span class="pre">data</span> <span class="pre">shape</span></code>, <code class="docutils literal notranslate"><span class="pre">dimensions</span></code>, <code class="docutils literal notranslate"><span class="pre">affine</span></code>, <code class="docutils literal notranslate"><span class="pre">meta-data</span></code> and much more. All of them are very useful and good to know (and should be identical to values indicated the corresponding <a class="reference external" href="https://bids-specification.readthedocs.io/en/stable/02-common-principles.html#keyvalue-files-dictionaries">json sidecar file</a> if you use <a class="reference external" href="https://bids.neuroimaging.io/">BIDS</a>).</p>
<div class="dropdown admonition">
<p class="admonition-title">Question</p>
<p>Please have a look at each of the <code class="docutils literal notranslate"><span class="pre">field</span></code>s displayed above and try to answer the following questions:</p>
<ul class="simple">
<li><p>what does the <code class="docutils literal notranslate"><span class="pre">value</span></code> refer to?</p></li>
<li><p>what does the respective <code class="docutils literal notranslate"><span class="pre">information</span></code> represent?</p></li>
</ul>
</div>
<div class="section" id="accessing-specific-parameters">
<h3>Accessing specific parameters<a class="headerlink" href="#accessing-specific-parameters" title="Permalink to this headline">¶</a></h3>
<p>Seeing all these <code class="docutils literal notranslate"><span class="pre">parameters</span></code> entailed in the <code class="docutils literal notranslate"><span class="pre">header</span></code> we might want to evaluate and utilize some of them during various points of our <code class="docutils literal notranslate"><span class="pre">analysis</span> <span class="pre">pipeline</span></code>. With <code class="docutils literal notranslate"><span class="pre">nibabel</span></code> we can easily access all of them, either directly, e.g. the <code class="docutils literal notranslate"><span class="pre">affine</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">affine</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">affine</span>
<span class="n">affine</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[-3.99471426e+00, -2.04233140e-01,  2.29353290e-02,
         1.30641693e+02],
       [-2.05448717e-01,  3.98260689e+00, -3.10890853e-01,
        -9.74732285e+01],
       [ 6.95819734e-03,  3.11659902e-01,  3.98780894e+00,
        -8.06465759e+01],
       [ 0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
         1.00000000e+00]])
</pre></div>
</div>
</div>
</div>
<p>or through the <code class="docutils literal notranslate"><span class="pre">header</span></code> <code class="docutils literal notranslate"><span class="pre">object</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">header</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;pixdim&#39;</span><span class="p">]</span>
<span class="n">header</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-1.      ,  4.      ,  4.      ,  3.999975,  2.5     ,  1.      ,
        1.      ,  1.      ], dtype=float32)
</pre></div>
</div>
</div>
</div>
<div class="admonition-note admonition">
<p class="admonition-title">Note</p>
<p>Note that in the <code class="docutils literal notranslate"><span class="pre">'pixdim'</span></code> above contains the voxel resolution  (<code class="docutils literal notranslate"><span class="pre">4.,</span> <span class="pre">4.,</span> <span class="pre">3.999</span></code>), as well as the TR (<code class="docutils literal notranslate"><span class="pre">2.5</span></code>).</p>
</div>
<p>Furthermore, we can also access the underlying <code class="docutils literal notranslate"><span class="pre">data</span></code> of the <code class="docutils literal notranslate"><span class="pre">image</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
<span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(64, 64, 30, 184)
</pre></div>
</div>
</div>
</div>
<div class="section" id="notes-on-working-with-neuroimaging-and-memory-allocation">
<h4>Notes on working with neuroimaging and memory allocation<a class="headerlink" href="#notes-on-working-with-neuroimaging-and-memory-allocation" title="Permalink to this headline">¶</a></h4>
<p>Why not just directly access the <code class="docutils literal notranslate"><span class="pre">data</span></code> via <code class="docutils literal notranslate"><span class="pre">img.data</span></code>? Working with <code class="docutils literal notranslate"><span class="pre">neuroimages</span></code> can use a lot of <code class="docutils literal notranslate"><span class="pre">memory</span></code>, so <code class="docutils literal notranslate"><span class="pre">nibabel</span></code> works hard to be <code class="docutils literal notranslate"><span class="pre">memory</span> <span class="pre">efficient</span></code>. If it can read some <code class="docutils literal notranslate"><span class="pre">data</span></code> while leaving the rest on <code class="docutils literal notranslate"><span class="pre">disk</span></code>, it will. <code class="docutils literal notranslate"><span class="pre">img.get_data()</span></code> reflects that it’s doing exactly that via some work behind the scenes.</p>
<p>Lets dive a bit further into this:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">img.get_data_dtype()</span></code> shows the <code class="docutils literal notranslate"><span class="pre">type</span></code> of the <code class="docutils literal notranslate"><span class="pre">data</span></code> on <code class="docutils literal notranslate"><span class="pre">disk</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">img.get_data().dtype</span></code> shows the <code class="docutils literal notranslate"><span class="pre">type</span></code> of the <code class="docutils literal notranslate"><span class="pre">data</span></code> that you’re working with</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">get_data_dtype</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(dtype(&#39;&lt;i2&#39;), dtype(&#39;&lt;i2&#39;))
</pre></div>
</div>
</div>
</div>
<p>Even though true here, these are not always the same, and not being clear on this <a class="reference external" href="https://github.com/nipy/nibabel/issues/490">has caused problems</a>. Further, modifying one does not update the other. This is especially important to keep in mind later when saving <code class="docutils literal notranslate"><span class="pre">files</span></code>.</p>
</div>
</div>
<div class="section" id="what-s-actually-in-the-neuroimaging-data">
<h3>What’s actually in the <code class="docutils literal notranslate"><span class="pre">neuroimaging</span></code> <code class="docutils literal notranslate"><span class="pre">data</span></code>?<a class="headerlink" href="#what-s-actually-in-the-neuroimaging-data" title="Permalink to this headline">¶</a></h3>
<p>It might sound less crazy/fancy than you thought/hoped for but the <code class="docutils literal notranslate"><span class="pre">data</span></code> is a simple <code class="docutils literal notranslate"><span class="pre">numpy</span></code> <code class="docutils literal notranslate"><span class="pre">array</span></code>. It has a <code class="docutils literal notranslate"><span class="pre">shape</span></code>, it can be <code class="docutils literal notranslate"><span class="pre">sliced</span></code> and generally manipulated as you would any <code class="docutils literal notranslate"><span class="pre">array</span></code> as it contains <code class="docutils literal notranslate"><span class="pre">numerical</span> <span class="pre">values</span></code> in certain <code class="docutils literal notranslate"><span class="pre">dimensions</span></code> with certain expressions. Lets use <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> to visualize the <code class="docutils literal notranslate"><span class="pre">data</span></code> after directly accessing it via <code class="docutils literal notranslate"><span class="pre">numpy</span></code> to make this more clear:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(64, 64, 30, 184)
</pre></div>
</div>
<img alt="../../../_images/image_manipulation_nibabel_22_1.png" src="../../../_images/image_manipulation_nibabel_22_1.png" />
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Question</p>
<p>Think about what the <code class="docutils literal notranslate"><span class="pre">data</span></code> and the respective <code class="docutils literal notranslate"><span class="pre">values</span></code> represents in terms of the discussed <code class="docutils literal notranslate"><span class="pre">MRI</span></code> principles and the signal we obtain through it.</p>
</div>
</div>
<div class="section" id="practical-exercise-1">
<h3>Practical exercise 1:<a class="headerlink" href="#practical-exercise-1" title="Permalink to this headline">¶</a></h3>
<p>How about some small practical exercise to further familiarize yourself with <code class="docutils literal notranslate"><span class="pre">nibabel</span></code> and <code class="docutils literal notranslate"><span class="pre">neuroimaging</span></code> <code class="docutils literal notranslate"><span class="pre">data</span></code> handling?</p>
<p>Please load the <code class="docutils literal notranslate"><span class="pre">T1w</span></code> <code class="docutils literal notranslate"><span class="pre">data</span></code> from <code class="docutils literal notranslate"><span class="pre">subject</span> <span class="pre">1</span></code> and then <code class="docutils literal notranslate"><span class="pre">plot</span></code> the <code class="docutils literal notranslate"><span class="pre">image</span></code> using the same <code class="docutils literal notranslate"><span class="pre">volume</span></code> <code class="docutils literal notranslate"><span class="pre">indexing</span></code> as before. Also, please <code class="docutils literal notranslate"><span class="pre">print</span></code> the <code class="docutils literal notranslate"><span class="pre">shape</span></code> of the <code class="docutils literal notranslate"><span class="pre">data</span></code>. Don’t worry if get stuck: just give it your best try and if it doesn’t work out, have a look at the solution below!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># work on solution here</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Solution</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>t1 = nb.load(&#39;/data/ds000114/sub-01/ses-test/anat/sub-01_ses-test_T1w.nii.gz&#39;)
data = t1.get_data()
plt.imshow(data[:, :, data.shape[2] // 2].T, cmap=&#39;Greys_r&#39;)
print(data.shape)
</pre></div>
</div>
</div>
</div>
<div class="section" id="visually-inspecting-images-via-orthoview">
<h3>Visually inspecting <code class="docutils literal notranslate"><span class="pre">images</span></code> via <code class="docutils literal notranslate"><span class="pre">orthoview()</span></code><a class="headerlink" href="#visually-inspecting-images-via-orthoview" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">Nibabel</span></code> has its own <code class="docutils literal notranslate"><span class="pre">viewer</span></code>, which can be accessed through <strong><code class="docutils literal notranslate"><span class="pre">img.orthoview()</span></code></strong> where <code class="docutils literal notranslate"><span class="pre">img</span></code> is the <code class="docutils literal notranslate"><span class="pre">image</span></code> you <code class="docutils literal notranslate"><span class="pre">loaded</span></code> via e.g. <code class="docutils literal notranslate"><span class="pre">.load</span></code>. It should present you with either <code class="docutils literal notranslate"><span class="pre">3</span></code> or <code class="docutils literal notranslate"><span class="pre">4</span></code> <code class="docutils literal notranslate"><span class="pre">subplots</span></code> for the respective <code class="docutils literal notranslate"><span class="pre">dimensions</span></code>, ie. <code class="docutils literal notranslate"><span class="pre">3</span></code> <code class="docutils literal notranslate"><span class="pre">spatial</span></code> (<code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, <code class="docutils literal notranslate"><span class="pre">z</span></code>) and in case of <code class="docutils literal notranslate"><span class="pre">fMRI</span></code> <code class="docutils literal notranslate"><span class="pre">images</span></code> <code class="docutils literal notranslate"><span class="pre">1</span></code> <code class="docutils literal notranslate"><span class="pre">temporal</span></code>(<code class="docutils literal notranslate"><span class="pre">time</span></code> indicated via <code class="docutils literal notranslate"><span class="pre">TR</span></code>). This <code class="docutils literal notranslate"><span class="pre">viewer</span></code> <code class="docutils literal notranslate"><span class="pre">scales</span></code> <code class="docutils literal notranslate"><span class="pre">voxels</span></code> to reflect their <code class="docutils literal notranslate"><span class="pre">size</span></code>, and <code class="docutils literal notranslate"><span class="pre">label</span></code> orientations.</p>
<p><strong>Warning:</strong> <code class="docutils literal notranslate"><span class="pre">img.orthoview()</span></code> may not work properly on OS X.</p>
<div class="section" id="sidenote-on-plotting-with-orthoview">
<h4>Sidenote on plotting with <code class="docutils literal notranslate"><span class="pre">orthoview()</span></code><a class="headerlink" href="#sidenote-on-plotting-with-orthoview" title="Permalink to this headline">¶</a></h4>
<p>As with other figures, f you initiated <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> with <code class="docutils literal notranslate"><span class="pre">%matplotlib</span> <span class="pre">inline</span></code>, the output figure will be static. If you use <code class="docutils literal notranslate"><span class="pre">orthoview()</span></code> in a normal <code class="docutils literal notranslate"><span class="pre">IPython</span> <span class="pre">console</span></code>, it will create an <code class="docutils literal notranslate"><span class="pre">interactive</span></code> window, and you can click to select different slices, similar to <code class="docutils literal notranslate"><span class="pre">mricron</span></code> or comparable viewers. To get a similar experience in a <code class="docutils literal notranslate"><span class="pre">jupyter</span> <span class="pre">notebook</span></code>, use <code class="docutils literal notranslate"><span class="pre">%matplotlib</span> <span class="pre">notebook</span></code>. But don’t forget to close <code class="docutils literal notranslate"><span class="pre">figures</span></code> afterward again or use <code class="docutils literal notranslate"><span class="pre">%matplotlib</span> <span class="pre">inline</span></code> again, otherwise, you cannot <code class="docutils literal notranslate"><span class="pre">plot</span></code> any other <code class="docutils literal notranslate"><span class="pre">figures</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> notebook
<span class="n">img</span><span class="o">.</span><span class="n">orthoview</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">/* Put everything inside the global mpl namespace */
/* global mpl */
window.mpl = {};

mpl.get_websocket_type = function () {
    if (typeof WebSocket !== 'undefined') {
        return WebSocket;
    } else if (typeof MozWebSocket !== 'undefined') {
        return MozWebSocket;
    } else {
        alert(
            'Your browser does not have WebSocket support. ' +
                'Please try Chrome, Safari or Firefox ≥ 6. ' +
                'Firefox 4 and 5 are also supported but you ' +
                'have to enable WebSockets in about:config.'
        );
    }
};

mpl.figure = function (figure_id, websocket, ondownload, parent_element) {
    this.id = figure_id;

    this.ws = websocket;

    this.supports_binary = this.ws.binaryType !== undefined;

    if (!this.supports_binary) {
        var warnings = document.getElementById('mpl-warnings');
        if (warnings) {
            warnings.style.display = 'block';
            warnings.textContent =
                'This browser does not support binary websocket messages. ' +
                'Performance may be slow.';
        }
    }

    this.imageObj = new Image();

    this.context = undefined;
    this.message = undefined;
    this.canvas = undefined;
    this.rubberband_canvas = undefined;
    this.rubberband_context = undefined;
    this.format_dropdown = undefined;

    this.image_mode = 'full';

    this.root = document.createElement('div');
    this.root.setAttribute('style', 'display: inline-block');
    this._root_extra_style(this.root);

    parent_element.appendChild(this.root);

    this._init_header(this);
    this._init_canvas(this);
    this._init_toolbar(this);

    var fig = this;

    this.waiting = false;

    this.ws.onopen = function () {
        fig.send_message('supports_binary', { value: fig.supports_binary });
        fig.send_message('send_image_mode', {});
        if (fig.ratio !== 1) {
            fig.send_message('set_device_pixel_ratio', {
                device_pixel_ratio: fig.ratio,
            });
        }
        fig.send_message('refresh', {});
    };

    this.imageObj.onload = function () {
        if (fig.image_mode === 'full') {
            // Full images could contain transparency (where diff images
            // almost always do), so we need to clear the canvas so that
            // there is no ghosting.
            fig.context.clearRect(0, 0, fig.canvas.width, fig.canvas.height);
        }
        fig.context.drawImage(fig.imageObj, 0, 0);
    };

    this.imageObj.onunload = function () {
        fig.ws.close();
    };

    this.ws.onmessage = this._make_on_message_function(this);

    this.ondownload = ondownload;
};

mpl.figure.prototype._init_header = function () {
    var titlebar = document.createElement('div');
    titlebar.classList =
        'ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix';
    var titletext = document.createElement('div');
    titletext.classList = 'ui-dialog-title';
    titletext.setAttribute(
        'style',
        'width: 100%; text-align: center; padding: 3px;'
    );
    titlebar.appendChild(titletext);
    this.root.appendChild(titlebar);
    this.header = titletext;
};

mpl.figure.prototype._canvas_extra_style = function (_canvas_div) {};

mpl.figure.prototype._root_extra_style = function (_canvas_div) {};

mpl.figure.prototype._init_canvas = function () {
    var fig = this;

    var canvas_div = (this.canvas_div = document.createElement('div'));
    canvas_div.setAttribute(
        'style',
        'border: 1px solid #ddd;' +
            'box-sizing: content-box;' +
            'clear: both;' +
            'min-height: 1px;' +
            'min-width: 1px;' +
            'outline: 0;' +
            'overflow: hidden;' +
            'position: relative;' +
            'resize: both;'
    );

    function on_keyboard_event_closure(name) {
        return function (event) {
            return fig.key_event(event, name);
        };
    }

    canvas_div.addEventListener(
        'keydown',
        on_keyboard_event_closure('key_press')
    );
    canvas_div.addEventListener(
        'keyup',
        on_keyboard_event_closure('key_release')
    );

    this._canvas_extra_style(canvas_div);
    this.root.appendChild(canvas_div);

    var canvas = (this.canvas = document.createElement('canvas'));
    canvas.classList.add('mpl-canvas');
    canvas.setAttribute('style', 'box-sizing: content-box;');

    this.context = canvas.getContext('2d');

    var backingStore =
        this.context.backingStorePixelRatio ||
        this.context.webkitBackingStorePixelRatio ||
        this.context.mozBackingStorePixelRatio ||
        this.context.msBackingStorePixelRatio ||
        this.context.oBackingStorePixelRatio ||
        this.context.backingStorePixelRatio ||
        1;

    this.ratio = (window.devicePixelRatio || 1) / backingStore;

    var rubberband_canvas = (this.rubberband_canvas = document.createElement(
        'canvas'
    ));
    rubberband_canvas.setAttribute(
        'style',
        'box-sizing: content-box; position: absolute; left: 0; top: 0; z-index: 1;'
    );

    // Apply a ponyfill if ResizeObserver is not implemented by browser.
    if (this.ResizeObserver === undefined) {
        if (window.ResizeObserver !== undefined) {
            this.ResizeObserver = window.ResizeObserver;
        } else {
            var obs = _JSXTOOLS_RESIZE_OBSERVER({});
            this.ResizeObserver = obs.ResizeObserver;
        }
    }

    this.resizeObserverInstance = new this.ResizeObserver(function (entries) {
        var nentries = entries.length;
        for (var i = 0; i < nentries; i++) {
            var entry = entries[i];
            var width, height;
            if (entry.contentBoxSize) {
                if (entry.contentBoxSize instanceof Array) {
                    // Chrome 84 implements new version of spec.
                    width = entry.contentBoxSize[0].inlineSize;
                    height = entry.contentBoxSize[0].blockSize;
                } else {
                    // Firefox implements old version of spec.
                    width = entry.contentBoxSize.inlineSize;
                    height = entry.contentBoxSize.blockSize;
                }
            } else {
                // Chrome <84 implements even older version of spec.
                width = entry.contentRect.width;
                height = entry.contentRect.height;
            }

            // Keep the size of the canvas and rubber band canvas in sync with
            // the canvas container.
            if (entry.devicePixelContentBoxSize) {
                // Chrome 84 implements new version of spec.
                canvas.setAttribute(
                    'width',
                    entry.devicePixelContentBoxSize[0].inlineSize
                );
                canvas.setAttribute(
                    'height',
                    entry.devicePixelContentBoxSize[0].blockSize
                );
            } else {
                canvas.setAttribute('width', width * fig.ratio);
                canvas.setAttribute('height', height * fig.ratio);
            }
            canvas.setAttribute(
                'style',
                'width: ' + width + 'px; height: ' + height + 'px;'
            );

            rubberband_canvas.setAttribute('width', width);
            rubberband_canvas.setAttribute('height', height);

            // And update the size in Python. We ignore the initial 0/0 size
            // that occurs as the element is placed into the DOM, which should
            // otherwise not happen due to the minimum size styling.
            if (fig.ws.readyState == 1 && width != 0 && height != 0) {
                fig.request_resize(width, height);
            }
        }
    });
    this.resizeObserverInstance.observe(canvas_div);

    function on_mouse_event_closure(name) {
        return function (event) {
            return fig.mouse_event(event, name);
        };
    }

    rubberband_canvas.addEventListener(
        'mousedown',
        on_mouse_event_closure('button_press')
    );
    rubberband_canvas.addEventListener(
        'mouseup',
        on_mouse_event_closure('button_release')
    );
    rubberband_canvas.addEventListener(
        'dblclick',
        on_mouse_event_closure('dblclick')
    );
    // Throttle sequential mouse events to 1 every 20ms.
    rubberband_canvas.addEventListener(
        'mousemove',
        on_mouse_event_closure('motion_notify')
    );

    rubberband_canvas.addEventListener(
        'mouseenter',
        on_mouse_event_closure('figure_enter')
    );
    rubberband_canvas.addEventListener(
        'mouseleave',
        on_mouse_event_closure('figure_leave')
    );

    canvas_div.addEventListener('wheel', function (event) {
        if (event.deltaY < 0) {
            event.step = 1;
        } else {
            event.step = -1;
        }
        on_mouse_event_closure('scroll')(event);
    });

    canvas_div.appendChild(canvas);
    canvas_div.appendChild(rubberband_canvas);

    this.rubberband_context = rubberband_canvas.getContext('2d');
    this.rubberband_context.strokeStyle = '#000000';

    this._resize_canvas = function (width, height, forward) {
        if (forward) {
            canvas_div.style.width = width + 'px';
            canvas_div.style.height = height + 'px';
        }
    };

    // Disable right mouse context menu.
    this.rubberband_canvas.addEventListener('contextmenu', function (_e) {
        event.preventDefault();
        return false;
    });

    function set_focus() {
        canvas.focus();
        canvas_div.focus();
    }

    window.setTimeout(set_focus, 100);
};

mpl.figure.prototype._init_toolbar = function () {
    var fig = this;

    var toolbar = document.createElement('div');
    toolbar.classList = 'mpl-toolbar';
    this.root.appendChild(toolbar);

    function on_click_closure(name) {
        return function (_event) {
            return fig.toolbar_button_onclick(name);
        };
    }

    function on_mouseover_closure(tooltip) {
        return function (event) {
            if (!event.currentTarget.disabled) {
                return fig.toolbar_button_onmouseover(tooltip);
            }
        };
    }

    fig.buttons = {};
    var buttonGroup = document.createElement('div');
    buttonGroup.classList = 'mpl-button-group';
    for (var toolbar_ind in mpl.toolbar_items) {
        var name = mpl.toolbar_items[toolbar_ind][0];
        var tooltip = mpl.toolbar_items[toolbar_ind][1];
        var image = mpl.toolbar_items[toolbar_ind][2];
        var method_name = mpl.toolbar_items[toolbar_ind][3];

        if (!name) {
            /* Instead of a spacer, we start a new button group. */
            if (buttonGroup.hasChildNodes()) {
                toolbar.appendChild(buttonGroup);
            }
            buttonGroup = document.createElement('div');
            buttonGroup.classList = 'mpl-button-group';
            continue;
        }

        var button = (fig.buttons[name] = document.createElement('button'));
        button.classList = 'mpl-widget';
        button.setAttribute('role', 'button');
        button.setAttribute('aria-disabled', 'false');
        button.addEventListener('click', on_click_closure(method_name));
        button.addEventListener('mouseover', on_mouseover_closure(tooltip));

        var icon_img = document.createElement('img');
        icon_img.src = '_images/' + image + '.png';
        icon_img.srcset = '_images/' + image + '_large.png 2x';
        icon_img.alt = tooltip;
        button.appendChild(icon_img);

        buttonGroup.appendChild(button);
    }

    if (buttonGroup.hasChildNodes()) {
        toolbar.appendChild(buttonGroup);
    }

    var fmt_picker = document.createElement('select');
    fmt_picker.classList = 'mpl-widget';
    toolbar.appendChild(fmt_picker);
    this.format_dropdown = fmt_picker;

    for (var ind in mpl.extensions) {
        var fmt = mpl.extensions[ind];
        var option = document.createElement('option');
        option.selected = fmt === mpl.default_extension;
        option.innerHTML = fmt;
        fmt_picker.appendChild(option);
    }

    var status_bar = document.createElement('span');
    status_bar.classList = 'mpl-message';
    toolbar.appendChild(status_bar);
    this.message = status_bar;
};

mpl.figure.prototype.request_resize = function (x_pixels, y_pixels) {
    // Request matplotlib to resize the figure. Matplotlib will then trigger a resize in the client,
    // which will in turn request a refresh of the image.
    this.send_message('resize', { width: x_pixels, height: y_pixels });
};

mpl.figure.prototype.send_message = function (type, properties) {
    properties['type'] = type;
    properties['figure_id'] = this.id;
    this.ws.send(JSON.stringify(properties));
};

mpl.figure.prototype.send_draw_message = function () {
    if (!this.waiting) {
        this.waiting = true;
        this.ws.send(JSON.stringify({ type: 'draw', figure_id: this.id }));
    }
};

mpl.figure.prototype.handle_save = function (fig, _msg) {
    var format_dropdown = fig.format_dropdown;
    var format = format_dropdown.options[format_dropdown.selectedIndex].value;
    fig.ondownload(fig, format);
};

mpl.figure.prototype.handle_resize = function (fig, msg) {
    var size = msg['size'];
    if (size[0] !== fig.canvas.width || size[1] !== fig.canvas.height) {
        fig._resize_canvas(size[0], size[1], msg['forward']);
        fig.send_message('refresh', {});
    }
};

mpl.figure.prototype.handle_rubberband = function (fig, msg) {
    var x0 = msg['x0'] / fig.ratio;
    var y0 = (fig.canvas.height - msg['y0']) / fig.ratio;
    var x1 = msg['x1'] / fig.ratio;
    var y1 = (fig.canvas.height - msg['y1']) / fig.ratio;
    x0 = Math.floor(x0) + 0.5;
    y0 = Math.floor(y0) + 0.5;
    x1 = Math.floor(x1) + 0.5;
    y1 = Math.floor(y1) + 0.5;
    var min_x = Math.min(x0, x1);
    var min_y = Math.min(y0, y1);
    var width = Math.abs(x1 - x0);
    var height = Math.abs(y1 - y0);

    fig.rubberband_context.clearRect(
        0,
        0,
        fig.canvas.width / fig.ratio,
        fig.canvas.height / fig.ratio
    );

    fig.rubberband_context.strokeRect(min_x, min_y, width, height);
};

mpl.figure.prototype.handle_figure_label = function (fig, msg) {
    // Updates the figure title.
    fig.header.textContent = msg['label'];
};

mpl.figure.prototype.handle_cursor = function (fig, msg) {
    fig.rubberband_canvas.style.cursor = msg['cursor'];
};

mpl.figure.prototype.handle_message = function (fig, msg) {
    fig.message.textContent = msg['message'];
};

mpl.figure.prototype.handle_draw = function (fig, _msg) {
    // Request the server to send over a new figure.
    fig.send_draw_message();
};

mpl.figure.prototype.handle_image_mode = function (fig, msg) {
    fig.image_mode = msg['mode'];
};

mpl.figure.prototype.handle_history_buttons = function (fig, msg) {
    for (var key in msg) {
        if (!(key in fig.buttons)) {
            continue;
        }
        fig.buttons[key].disabled = !msg[key];
        fig.buttons[key].setAttribute('aria-disabled', !msg[key]);
    }
};

mpl.figure.prototype.handle_navigate_mode = function (fig, msg) {
    if (msg['mode'] === 'PAN') {
        fig.buttons['Pan'].classList.add('active');
        fig.buttons['Zoom'].classList.remove('active');
    } else if (msg['mode'] === 'ZOOM') {
        fig.buttons['Pan'].classList.remove('active');
        fig.buttons['Zoom'].classList.add('active');
    } else {
        fig.buttons['Pan'].classList.remove('active');
        fig.buttons['Zoom'].classList.remove('active');
    }
};

mpl.figure.prototype.updated_canvas_event = function () {
    // Called whenever the canvas gets updated.
    this.send_message('ack', {});
};

// A function to construct a web socket function for onmessage handling.
// Called in the figure constructor.
mpl.figure.prototype._make_on_message_function = function (fig) {
    return function socket_on_message(evt) {
        if (evt.data instanceof Blob) {
            var img = evt.data;
            if (img.type !== 'image/png') {
                /* FIXME: We get "Resource interpreted as Image but
                 * transferred with MIME type text/plain:" errors on
                 * Chrome.  But how to set the MIME type?  It doesn't seem
                 * to be part of the websocket stream */
                img.type = 'image/png';
            }

            /* Free the memory for the previous frames */
            if (fig.imageObj.src) {
                (window.URL || window.webkitURL).revokeObjectURL(
                    fig.imageObj.src
                );
            }

            fig.imageObj.src = (window.URL || window.webkitURL).createObjectURL(
                img
            );
            fig.updated_canvas_event();
            fig.waiting = false;
            return;
        } else if (
            typeof evt.data === 'string' &&
            evt.data.slice(0, 21) === 'data:image/png;base64'
        ) {
            fig.imageObj.src = evt.data;
            fig.updated_canvas_event();
            fig.waiting = false;
            return;
        }

        var msg = JSON.parse(evt.data);
        var msg_type = msg['type'];

        // Call the  "handle_{type}" callback, which takes
        // the figure and JSON message as its only arguments.
        try {
            var callback = fig['handle_' + msg_type];
        } catch (e) {
            console.log(
                "No handler for the '" + msg_type + "' message type: ",
                msg
            );
            return;
        }

        if (callback) {
            try {
                // console.log("Handling '" + msg_type + "' message: ", msg);
                callback(fig, msg);
            } catch (e) {
                console.log(
                    "Exception inside the 'handler_" + msg_type + "' callback:",
                    e,
                    e.stack,
                    msg
                );
            }
        }
    };
};

// from https://stackoverflow.com/questions/1114465/getting-mouse-location-in-canvas
mpl.findpos = function (e) {
    //this section is from http://www.quirksmode.org/js/events_properties.html
    var targ;
    if (!e) {
        e = window.event;
    }
    if (e.target) {
        targ = e.target;
    } else if (e.srcElement) {
        targ = e.srcElement;
    }
    if (targ.nodeType === 3) {
        // defeat Safari bug
        targ = targ.parentNode;
    }

    // pageX,Y are the mouse positions relative to the document
    var boundingRect = targ.getBoundingClientRect();
    var x = e.pageX - (boundingRect.left + document.body.scrollLeft);
    var y = e.pageY - (boundingRect.top + document.body.scrollTop);

    return { x: x, y: y };
};

/*
 * return a copy of an object with only non-object keys
 * we need this to avoid circular references
 * https://stackoverflow.com/a/24161582/3208463
 */
function simpleKeys(original) {
    return Object.keys(original).reduce(function (obj, key) {
        if (typeof original[key] !== 'object') {
            obj[key] = original[key];
        }
        return obj;
    }, {});
}

mpl.figure.prototype.mouse_event = function (event, name) {
    var canvas_pos = mpl.findpos(event);

    if (name === 'button_press') {
        this.canvas.focus();
        this.canvas_div.focus();
    }

    var x = canvas_pos.x * this.ratio;
    var y = canvas_pos.y * this.ratio;

    this.send_message(name, {
        x: x,
        y: y,
        button: event.button,
        step: event.step,
        guiEvent: simpleKeys(event),
    });

    /* This prevents the web browser from automatically changing to
     * the text insertion cursor when the button is pressed.  We want
     * to control all of the cursor setting manually through the
     * 'cursor' event from matplotlib */
    event.preventDefault();
    return false;
};

mpl.figure.prototype._key_event_extra = function (_event, _name) {
    // Handle any extra behaviour associated with a key event
};

mpl.figure.prototype.key_event = function (event, name) {
    // Prevent repeat events
    if (name === 'key_press') {
        if (event.key === this._key) {
            return;
        } else {
            this._key = event.key;
        }
    }
    if (name === 'key_release') {
        this._key = null;
    }

    var value = '';
    if (event.ctrlKey && event.key !== 'Control') {
        value += 'ctrl+';
    }
    else if (event.altKey && event.key !== 'Alt') {
        value += 'alt+';
    }
    else if (event.shiftKey && event.key !== 'Shift') {
        value += 'shift+';
    }

    value += 'k' + event.key;

    this._key_event_extra(event, name);

    this.send_message(name, { key: value, guiEvent: simpleKeys(event) });
    return false;
};

mpl.figure.prototype.toolbar_button_onclick = function (name) {
    if (name === 'download') {
        this.handle_save(this, null);
    } else {
        this.send_message('toolbar_button', { name: name });
    }
};

mpl.figure.prototype.toolbar_button_onmouseover = function (tooltip) {
    this.message.textContent = tooltip;
};

///////////////// REMAINING CONTENT GENERATED BY embed_js.py /////////////////
// prettier-ignore
var _JSXTOOLS_RESIZE_OBSERVER=function(A){var t,i=new WeakMap,n=new WeakMap,a=new WeakMap,r=new WeakMap,o=new Set;function s(e){if(!(this instanceof s))throw new TypeError("Constructor requires 'new' operator");i.set(this,e)}function h(){throw new TypeError("Function is not a constructor")}function c(e,t,i,n){e=0 in arguments?Number(arguments[0]):0,t=1 in arguments?Number(arguments[1]):0,i=2 in arguments?Number(arguments[2]):0,n=3 in arguments?Number(arguments[3]):0,this.right=(this.x=this.left=e)+(this.width=i),this.bottom=(this.y=this.top=t)+(this.height=n),Object.freeze(this)}function d(){t=requestAnimationFrame(d);var s=new WeakMap,p=new Set;o.forEach((function(t){r.get(t).forEach((function(i){var r=t instanceof window.SVGElement,o=a.get(t),d=r?0:parseFloat(o.paddingTop),f=r?0:parseFloat(o.paddingRight),l=r?0:parseFloat(o.paddingBottom),u=r?0:parseFloat(o.paddingLeft),g=r?0:parseFloat(o.borderTopWidth),m=r?0:parseFloat(o.borderRightWidth),w=r?0:parseFloat(o.borderBottomWidth),b=u+f,F=d+l,v=(r?0:parseFloat(o.borderLeftWidth))+m,W=g+w,y=r?0:t.offsetHeight-W-t.clientHeight,E=r?0:t.offsetWidth-v-t.clientWidth,R=b+v,z=F+W,M=r?t.width:parseFloat(o.width)-R-E,O=r?t.height:parseFloat(o.height)-z-y;if(n.has(t)){var k=n.get(t);if(k[0]===M&&k[1]===O)return}n.set(t,[M,O]);var S=Object.create(h.prototype);S.target=t,S.contentRect=new c(u,d,M,O),s.has(i)||(s.set(i,[]),p.add(i)),s.get(i).push(S)}))})),p.forEach((function(e){i.get(e).call(e,s.get(e),e)}))}return s.prototype.observe=function(i){if(i instanceof window.Element){r.has(i)||(r.set(i,new Set),o.add(i),a.set(i,window.getComputedStyle(i)));var n=r.get(i);n.has(this)||n.add(this),cancelAnimationFrame(t),t=requestAnimationFrame(d)}},s.prototype.unobserve=function(i){if(i instanceof window.Element&&r.has(i)){var n=r.get(i);n.has(this)&&(n.delete(this),n.size||(r.delete(i),o.delete(i))),n.size||r.delete(i),o.size||cancelAnimationFrame(t)}},A.DOMRectReadOnly=c,A.ResizeObserver=s,A.ResizeObserverEntry=h,A}; // eslint-disable-line
mpl.toolbar_items = [["Home", "Reset original view", "fa fa-home icon-home", "home"], ["Back", "Back to previous view", "fa fa-arrow-left icon-arrow-left", "back"], ["Forward", "Forward to next view", "fa fa-arrow-right icon-arrow-right", "forward"], ["", "", "", ""], ["Pan", "Left button pans, Right button zooms\nx/y fixes axis, CTRL fixes aspect", "fa fa-arrows icon-move", "pan"], ["Zoom", "Zoom to rectangle\nx/y fixes axis", "fa fa-square-o icon-check-empty", "zoom"], ["", "", "", ""], ["Download", "Download plot", "fa fa-floppy-o icon-save", "download"]];

mpl.extensions = ["eps", "jpeg", "pgf", "pdf", "png", "ps", "raw", "svg", "tif"];

mpl.default_extension = "png";/* global mpl */

var comm_websocket_adapter = function (comm) {
    // Create a "websocket"-like object which calls the given IPython comm
    // object with the appropriate methods. Currently this is a non binary
    // socket, so there is still some room for performance tuning.
    var ws = {};

    ws.binaryType = comm.kernel.ws.binaryType;
    ws.readyState = comm.kernel.ws.readyState;
    function updateReadyState(_event) {
        if (comm.kernel.ws) {
            ws.readyState = comm.kernel.ws.readyState;
        } else {
            ws.readyState = 3; // Closed state.
        }
    }
    comm.kernel.ws.addEventListener('open', updateReadyState);
    comm.kernel.ws.addEventListener('close', updateReadyState);
    comm.kernel.ws.addEventListener('error', updateReadyState);

    ws.close = function () {
        comm.close();
    };
    ws.send = function (m) {
        //console.log('sending', m);
        comm.send(m);
    };
    // Register the callback with on_msg.
    comm.on_msg(function (msg) {
        //console.log('receiving', msg['content']['data'], msg);
        var data = msg['content']['data'];
        if (data['blob'] !== undefined) {
            data = {
                data: new Blob(msg['buffers'], { type: data['blob'] }),
            };
        }
        // Pass the mpl event to the overridden (by mpl) onmessage function.
        ws.onmessage(data);
    });
    return ws;
};

mpl.mpl_figure_comm = function (comm, msg) {
    // This is the function which gets called when the mpl process
    // starts-up an IPython Comm through the "matplotlib" channel.

    var id = msg.content.data.id;
    // Get hold of the div created by the display call when the Comm
    // socket was opened in Python.
    var element = document.getElementById(id);
    var ws_proxy = comm_websocket_adapter(comm);

    function ondownload(figure, _format) {
        window.open(figure.canvas.toDataURL());
    }

    var fig = new mpl.figure(id, ws_proxy, ondownload, element);

    // Call onopen now - mpl needs it, as it is assuming we've passed it a real
    // web socket which is closed, not our websocket->open comm proxy.
    ws_proxy.onopen();

    fig.parent_element = element;
    fig.cell_info = mpl.find_output_cell("<div id='" + id + "'></div>");
    if (!fig.cell_info) {
        console.error('Failed to find cell for figure', id, fig);
        return;
    }
    fig.cell_info[0].output_area.element.on(
        'cleared',
        { fig: fig },
        fig._remove_fig_handler
    );
};

mpl.figure.prototype.handle_close = function (fig, msg) {
    var width = fig.canvas.width / fig.ratio;
    fig.cell_info[0].output_area.element.off(
        'cleared',
        fig._remove_fig_handler
    );
    fig.resizeObserverInstance.unobserve(fig.canvas_div);

    // Update the output cell to use the data from the current canvas.
    fig.push_to_output();
    var dataURL = fig.canvas.toDataURL();
    // Re-enable the keyboard manager in IPython - without this line, in FF,
    // the notebook keyboard shortcuts fail.
    IPython.keyboard_manager.enable();
    fig.parent_element.innerHTML =
        '<img src="' + dataURL + '" width="' + width + '">';
    fig.close_ws(fig, msg);
};

mpl.figure.prototype.close_ws = function (fig, msg) {
    fig.send_message('closing', msg);
    // fig.ws.close()
};

mpl.figure.prototype.push_to_output = function (_remove_interactive) {
    // Turn the data on the canvas into data in the output cell.
    var width = this.canvas.width / this.ratio;
    var dataURL = this.canvas.toDataURL();
    this.cell_info[1]['text/html'] =
        '<img src="' + dataURL + '" width="' + width + '">';
};

mpl.figure.prototype.updated_canvas_event = function () {
    // Tell IPython that the notebook contents must change.
    IPython.notebook.set_dirty(true);
    this.send_message('ack', {});
    var fig = this;
    // Wait a second, then push the new image to the DOM so
    // that it is saved nicely (might be nice to debounce this).
    setTimeout(function () {
        fig.push_to_output();
    }, 1000);
};

mpl.figure.prototype._init_toolbar = function () {
    var fig = this;

    var toolbar = document.createElement('div');
    toolbar.classList = 'btn-toolbar';
    this.root.appendChild(toolbar);

    function on_click_closure(name) {
        return function (_event) {
            return fig.toolbar_button_onclick(name);
        };
    }

    function on_mouseover_closure(tooltip) {
        return function (event) {
            if (!event.currentTarget.disabled) {
                return fig.toolbar_button_onmouseover(tooltip);
            }
        };
    }

    fig.buttons = {};
    var buttonGroup = document.createElement('div');
    buttonGroup.classList = 'btn-group';
    var button;
    for (var toolbar_ind in mpl.toolbar_items) {
        var name = mpl.toolbar_items[toolbar_ind][0];
        var tooltip = mpl.toolbar_items[toolbar_ind][1];
        var image = mpl.toolbar_items[toolbar_ind][2];
        var method_name = mpl.toolbar_items[toolbar_ind][3];

        if (!name) {
            /* Instead of a spacer, we start a new button group. */
            if (buttonGroup.hasChildNodes()) {
                toolbar.appendChild(buttonGroup);
            }
            buttonGroup = document.createElement('div');
            buttonGroup.classList = 'btn-group';
            continue;
        }

        button = fig.buttons[name] = document.createElement('button');
        button.classList = 'btn btn-default';
        button.href = '#';
        button.title = name;
        button.innerHTML = '<i class="fa ' + image + ' fa-lg"></i>';
        button.addEventListener('click', on_click_closure(method_name));
        button.addEventListener('mouseover', on_mouseover_closure(tooltip));
        buttonGroup.appendChild(button);
    }

    if (buttonGroup.hasChildNodes()) {
        toolbar.appendChild(buttonGroup);
    }

    // Add the status bar.
    var status_bar = document.createElement('span');
    status_bar.classList = 'mpl-message pull-right';
    toolbar.appendChild(status_bar);
    this.message = status_bar;

    // Add the close button to the window.
    var buttongrp = document.createElement('div');
    buttongrp.classList = 'btn-group inline pull-right';
    button = document.createElement('button');
    button.classList = 'btn btn-mini btn-primary';
    button.href = '#';
    button.title = 'Stop Interaction';
    button.innerHTML = '<i class="fa fa-power-off icon-remove icon-large"></i>';
    button.addEventListener('click', function (_evt) {
        fig.handle_close(fig, {});
    });
    button.addEventListener(
        'mouseover',
        on_mouseover_closure('Stop Interaction')
    );
    buttongrp.appendChild(button);
    var titlebar = this.root.querySelector('.ui-dialog-titlebar');
    titlebar.insertBefore(buttongrp, titlebar.firstChild);
};

mpl.figure.prototype._remove_fig_handler = function (event) {
    var fig = event.data.fig;
    if (event.target !== this) {
        // Ignore bubbled events from children.
        return;
    }
    fig.close_ws(fig, {});
};

mpl.figure.prototype._root_extra_style = function (el) {
    el.style.boxSizing = 'content-box'; // override notebook setting of border-box.
};

mpl.figure.prototype._canvas_extra_style = function (el) {
    // this is important to make the div 'focusable
    el.setAttribute('tabindex', 0);
    // reach out to IPython and tell the keyboard manager to turn it's self
    // off when our div gets focus

    // location in version 3
    if (IPython.notebook.keyboard_manager) {
        IPython.notebook.keyboard_manager.register_events(el);
    } else {
        // location in version 2
        IPython.keyboard_manager.register_events(el);
    }
};

mpl.figure.prototype._key_event_extra = function (event, _name) {
    // Check for shift+enter
    if (event.shiftKey && event.which === 13) {
        this.canvas_div.blur();
        // select the cell after this one
        var index = IPython.notebook.find_cell_index(this.cell_info[0]);
        IPython.notebook.select(index + 1);
    }
};

mpl.figure.prototype.handle_save = function (fig, _msg) {
    fig.ondownload(fig, null);
};

mpl.find_output_cell = function (html_output) {
    // Return the cell and output element which can be found *uniquely* in the notebook.
    // Note - this is a bit hacky, but it is done because the "notebook_saving.Notebook"
    // IPython event is triggered only after the cells have been serialised, which for
    // our purposes (turning an active figure into a static one), is too late.
    var cells = IPython.notebook.get_cells();
    var ncells = cells.length;
    for (var i = 0; i < ncells; i++) {
        var cell = cells[i];
        if (cell.cell_type === 'code') {
            for (var j = 0; j < cell.output_area.outputs.length; j++) {
                var data = cell.output_area.outputs[j];
                if (data.data) {
                    // IPython >= 3 moved mimebundle to data attribute of output
                    data = data.data;
                }
                if (data['text/html'] === html_output) {
                    return [cell, data, j];
                }
            }
        }
    }
};

// Register the function which deals with the matplotlib target/channel.
// The kernel may be null if the page has been refreshed.
if (IPython.notebook.kernel !== null) {
    IPython.notebook.kernel.comm_manager.register_target(
        'matplotlib',
        mpl.mpl_figure_comm
    );
}
</script><div class="output text_html"><div id='229b7254-a54a-4846-b224-ee7ce29faa28'></div></div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;OrthoSlicer3D: /data/ds000114/sub-01/ses-test/func/sub-01_ses-test_task-fingerfootlips_bold.nii.gz (64, 64, 30, 184)&gt;
</pre></div>
</div>
</div>
</div>
<p>After we got a broad and general overview of <code class="docutils literal notranslate"><span class="pre">neuroimaging</span> <span class="pre">data</span></code> and what it entails, we should spend a bit more time on more precise aspects of <code class="docutils literal notranslate"><span class="pre">neuroimaging</span></code> <code class="docutils literal notranslate"><span class="pre">data</span></code> and its handling using <code class="docutils literal notranslate"><span class="pre">nibabel</span></code>. Specifically, we will spend a closer look at the <code class="docutils literal notranslate"><span class="pre">header</span></code> and the <code class="docutils literal notranslate"><span class="pre">affine</span></code>. <strong>Please note</strong> that we will be using the <code class="docutils literal notranslate"><span class="pre">t1w</span></code> <code class="docutils literal notranslate"><span class="pre">data</span></code> of <code class="docutils literal notranslate"><span class="pre">sub-01</span></code> for this part. Thus, if you didn’t went through the <code class="docutils literal notranslate"><span class="pre">previous</span></code> <code class="docutils literal notranslate"><span class="pre">exercise</span></code>, you should do so now or make sure to check/run the solution. To make sure everything works, please try to use <code class="docutils literal notranslate"><span class="pre">.orthoview()</span></code> to <code class="docutils literal notranslate"><span class="pre">plot</span></code> and <code class="docutils literal notranslate"><span class="pre">investigate</span></code> the <code class="docutils literal notranslate"><span class="pre">t1w</span></code> <code class="docutils literal notranslate"><span class="pre">image</span></code>.</p>
<div class="dropdown admonition">
<p class="admonition-title">Solution</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>t1.orthoview()
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="header">
<h3>Header<a class="headerlink" href="#header" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">header</span></code> is a general property of <code class="docutils literal notranslate"><span class="pre">neuroimaging</span> <span class="pre">data</span></code> in most <code class="docutils literal notranslate"><span class="pre">file</span> <span class="pre">formats</span></code> and in <code class="docutils literal notranslate"><span class="pre">nibabel</span></code> the structure that stores all of the <code class="docutils literal notranslate"><span class="pre">metadata</span></code> of the <code class="docutils literal notranslate"><span class="pre">image</span></code>. As indicated above, you can query it directly, if necessary. For example, getting the <code class="docutils literal notranslate"><span class="pre">description</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t1</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;descrip&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array(b&#39;FSL5.0&#39;, dtype=&#39;|S80&#39;)
</pre></div>
</div>
</div>
</div>
<p>But it also provides <code class="docutils literal notranslate"><span class="pre">interfaces</span></code> for the more common information, such as <code class="docutils literal notranslate"><span class="pre">get_zooms</span></code>, <code class="docutils literal notranslate"><span class="pre">get_xyzt_units</span></code>, <code class="docutils literal notranslate"><span class="pre">get_qform</span></code>, <code class="docutils literal notranslate"><span class="pre">get_sform</span></code> which respectively provide <code class="docutils literal notranslate"><span class="pre">spatial</span></code>, <code class="docutils literal notranslate"><span class="pre">temporal</span></code> and <code class="docutils literal notranslate"><span class="pre">affine</span></code> <code class="docutils literal notranslate"><span class="pre">information</span></code> of the <code class="docutils literal notranslate"><span class="pre">image</span></code> at hand:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t1</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1.0, 1.2993759, 1.0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t1</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_xyzt_units</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;mm&#39;, &#39;sec&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t1</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_qform</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 9.99131938e-01, -5.16292391e-02,  1.25136054e-02,
        -1.25263863e+02],
       [ 4.07721521e-02,  1.29202043e+00, -9.81179047e-02,
        -7.31330109e+01],
       [-8.54416425e-03,  1.28044319e-01,  9.95096119e-01,
        -1.77554291e+02],
       [ 0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
         1.00000000e+00]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t1</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_sform</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 9.99131918e-01, -5.16291820e-02,  1.25127016e-02,
        -1.25263863e+02],
       [ 4.07721959e-02,  1.29202044e+00, -9.81179178e-02,
        -7.31330109e+01],
       [-8.54506902e-03,  1.28044292e-01,  9.95096147e-01,
        -1.77554291e+02],
       [ 0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
         1.00000000e+00]])
</pre></div>
</div>
</div>
</div>
<p>Speaking of the <code class="docutils literal notranslate"><span class="pre">affine</span></code>, lets check it out in more detail:</p>
</div>
<div class="section" id="affine">
<h3>Affine<a class="headerlink" href="#affine" title="Permalink to this headline">¶</a></h3>
<p>In our case, the <code class="docutils literal notranslate"><span class="pre">affine</span></code> refers to a <code class="docutils literal notranslate"><span class="pre">4</span> <span class="pre">x</span> <span class="pre">4</span> <span class="pre">numpy</span> <span class="pre">array</span></code>. This describes the <code class="docutils literal notranslate"><span class="pre">transformation</span></code> from the <code class="docutils literal notranslate"><span class="pre">voxel</span> <span class="pre">space</span></code> (<code class="docutils literal notranslate"><span class="pre">indices</span></code> <code class="docutils literal notranslate"><span class="pre">[i,</span> <span class="pre">j,</span> <span class="pre">k]</span></code>) to the <code class="docutils literal notranslate"><span class="pre">reference</span> <span class="pre">space</span></code> (<code class="docutils literal notranslate"><span class="pre">distance</span></code> in <code class="docutils literal notranslate"><span class="pre">mm</span></code> <code class="docutils literal notranslate"><span class="pre">(x,</span> <span class="pre">y,</span> <span class="pre">z)</span></code>).</p>
<p>It can be used, for instance, to discover the <code class="docutils literal notranslate"><span class="pre">voxel</span></code> that contains the <code class="docutils literal notranslate"><span class="pre">origin</span></code> of the <code class="docutils literal notranslate"><span class="pre">image</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">affine</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Affine:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">affine</span><span class="p">)</span>
<span class="nb">print</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Center: (</span><span class="si">{:d}</span><span class="s2">, </span><span class="si">{:d}</span><span class="s2">, </span><span class="si">{:d}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Affine:
[[-3.99471426e+00 -2.04233140e-01  2.29353290e-02  1.30641693e+02]
 [-2.05448717e-01  3.98260689e+00 -3.10890853e-01 -9.74732285e+01]
 [ 6.95819734e-03  3.11659902e-01  3.98780894e+00 -8.06465759e+01]
 [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  1.00000000e+00]]
Center: (31, 27, 18)
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">affine</span></code> also encodes the <code class="docutils literal notranslate"><span class="pre">axis</span></code> <code class="docutils literal notranslate"><span class="pre">orientation</span></code> and <code class="docutils literal notranslate"><span class="pre">voxel</span> <span class="pre">sizes</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nb</span><span class="o">.</span><span class="n">aff2axcodes</span><span class="p">(</span><span class="n">affine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;L&#39;, &#39;A&#39;, &#39;S&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nb</span><span class="o">.</span><span class="n">affines</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">(</span><span class="n">affine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([3.99999995, 4.00000009, 3.99997491])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nb</span><span class="o">.</span><span class="n">aff2axcodes</span><span class="p">(</span><span class="n">affine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;L&#39;, &#39;A&#39;, &#39;S&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nb</span><span class="o">.</span><span class="n">affines</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">(</span><span class="n">affine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([3.99999995, 4.00000009, 3.99997491])
</pre></div>
</div>
</div>
</div>
<p>Normally, we’re not particularly interested in the <code class="docutils literal notranslate"><span class="pre">header</span></code> or the <code class="docutils literal notranslate"><span class="pre">affine</span></code>. But it’s important to know they’re there. And especially, to remember to copy them when making new <code class="docutils literal notranslate"><span class="pre">images</span></code> or working with <code class="docutils literal notranslate"><span class="pre">derivatives</span></code>, so that they stay aligned with the original <code class="docutils literal notranslate"><span class="pre">image</span></code> (if required).</p>
<p>Now you might think: it seems a bit cumbersome to get/access all that information to e.g. check and/or evaluate a given <code class="docutils literal notranslate"><span class="pre">image</span></code>. First of all: come on, it’s just a few lines of rather simple code. Second, if you really don’t want to fire up a <code class="docutils literal notranslate"><span class="pre">python</span></code> session and run a few commands/functions: <code class="docutils literal notranslate"><span class="pre">nibabel</span></code> also has your back here.</p>
</div>
</div>
<div class="section" id="nib-ls">
<h2><code class="docutils literal notranslate"><span class="pre">nib-ls</span></code><a class="headerlink" href="#nib-ls" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">Nibabel</span></code> comes packaged with a <code class="docutils literal notranslate"><span class="pre">command-line</span> <span class="pre">tool</span></code> called <a class="reference external" href="https://nipy.org/nibabel/reference/nibabel.cmdline.html?highlight=nib%20ls#module-nibabel.cmdline.ls">nib-lis</a> to <code class="docutils literal notranslate"><span class="pre">print</span></code> <code class="docutils literal notranslate"><span class="pre">common</span></code> <code class="docutils literal notranslate"><span class="pre">metadata</span></code> about any (<code class="docutils literal notranslate"><span class="pre">volumetric</span></code>) <code class="docutils literal notranslate"><span class="pre">neuroimaging</span></code> <code class="docutils literal notranslate"><span class="pre">format</span></code> <code class="docutils literal notranslate"><span class="pre">nibabel</span></code> supports. By default, it shows (<strong><code class="docutils literal notranslate"><span class="pre">on-disk</span></code></strong>) <code class="docutils literal notranslate"><span class="pre">data</span> <span class="pre">type</span></code>, <code class="docutils literal notranslate"><span class="pre">dimensions</span></code> and <code class="docutils literal notranslate"><span class="pre">voxel</span> <span class="pre">sizes</span></code>. Lets try it out via using the <code class="docutils literal notranslate"><span class="pre">fMRI</span></code> <code class="docutils literal notranslate"><span class="pre">data</span></code> of <code class="docutils literal notranslate"><span class="pre">sub-01</span></code> again:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>nib-ls /data/ds000114/sub-01/ses-test/func/sub-01_ses-test_task-fingerfootlips_bold.nii.gz
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/data/ds000114/sub-01/ses-test/func/sub-01_ses-test_task-fingerfootlips_bold.nii.gz int16 [ 64,  64,  30, 184] 4.00x4.00x4.00x2.50   sform
</pre></div>
</div>
</div>
</div>
<p>We can also inspect <code class="docutils literal notranslate"><span class="pre">header</span></code> <code class="docutils literal notranslate"><span class="pre">fields</span></code> by name, for instance, <code class="docutils literal notranslate"><span class="pre">descrip</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>nib-ls -H descrip /data/ds000114/sub-01/ses-test/anat/sub-01_ses-test_T1w.nii.gz
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/data/ds000114/sub-01/ses-test/anat/sub-01_ses-test_T1w.nii.gz float32 [256, 156, 256] 1.00x1.30x1.00   b&#39;FSL5.0&#39; sform
</pre></div>
</div>
</div>
</div>
<p>This concludes the basic <code class="docutils literal notranslate"><span class="pre">neuroimaging</span> <span class="pre">data</span></code> exploration section which discussed <code class="docutils literal notranslate"><span class="pre">commands</span></code> and <code class="docutils literal notranslate"><span class="pre">functions</span></code> should already allow you to do a lot of common tasks and work with <code class="docutils literal notranslate"><span class="pre">neuroimaging</span> <span class="pre">data</span></code>. However, there’s obviously way more to it. For example, <code class="docutils literal notranslate"><span class="pre">creating</span></code> and <code class="docutils literal notranslate"><span class="pre">saving</span></code> <code class="docutils literal notranslate"><span class="pre">images</span></code>.</p>
</div>
<div class="section" id="creating-and-saving-images">
<h2>Creating and saving images<a class="headerlink" href="#creating-and-saving-images" title="Permalink to this headline">¶</a></h2>
<p>Suppose we want to save <code class="docutils literal notranslate"><span class="pre">space</span></code> by <code class="docutils literal notranslate"><span class="pre">rescaling</span></code> our <code class="docutils literal notranslate"><span class="pre">image</span></code> to a smaller <code class="docutils literal notranslate"><span class="pre">datatype</span></code>, such as an <code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">byte</span></code>. To do this, we first need to take the <code class="docutils literal notranslate"><span class="pre">data</span></code>, change its <code class="docutils literal notranslate"><span class="pre">datatype</span></code> and <code class="docutils literal notranslate"><span class="pre">save</span></code> this new <code class="docutils literal notranslate"><span class="pre">data</span></code> in a new <code class="docutils literal notranslate"><span class="pre">NIfTI</span> <span class="pre">image</span></code> with the <strong>same</strong> <code class="docutils literal notranslate"><span class="pre">header</span></code> and <code class="docutils literal notranslate"><span class="pre">affine</span></code> as the <code class="docutils literal notranslate"><span class="pre">original</span> <span class="pre">image</span></code>. At first, we need to <code class="docutils literal notranslate"><span class="pre">load</span></code> the <code class="docutils literal notranslate"><span class="pre">image</span></code> and <code class="docutils literal notranslate"><span class="pre">get</span></code> the <code class="docutils literal notranslate"><span class="pre">data</span></code> (using the <code class="docutils literal notranslate"><span class="pre">fMRI</span></code> <code class="docutils literal notranslate"><span class="pre">data</span></code> of <code class="docutils literal notranslate"><span class="pre">sub-01</span></code> once more):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;/data/ds000114/sub-01/ses-test/func/sub-01_ses-test_task-fingerfootlips_bold.nii.gz&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Now we force the <code class="docutils literal notranslate"><span class="pre">values</span></code> to be between <code class="docutils literal notranslate"><span class="pre">0</span></code> and <code class="docutils literal notranslate"><span class="pre">255</span></code> and <code class="docutils literal notranslate"><span class="pre">change</span></code> the <code class="docutils literal notranslate"><span class="pre">datatype</span></code> to <code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">8-bit</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rescaled</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">*</span> <span class="mf">255.</span> <span class="o">/</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can <code class="docutils literal notranslate"><span class="pre">save</span></code> the changed <code class="docutils literal notranslate"><span class="pre">data</span></code> into a new <code class="docutils literal notranslate"><span class="pre">NIfTI</span> <span class="pre">file</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_img</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">rescaled</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
<span class="n">nb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">new_img</span><span class="p">,</span> <span class="s1">&#39;rescaled_image.nii.gz&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s look at the <code class="docutils literal notranslate"><span class="pre">datatypes</span></code> of the <code class="docutils literal notranslate"><span class="pre">data</span> <span class="pre">array</span></code>, as well as of the <code class="docutils literal notranslate"><span class="pre">nifti</span> <span class="pre">image</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">((</span><span class="n">new_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">new_img</span><span class="o">.</span><span class="n">get_data_dtype</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(dtype(&#39;float64&#39;), dtype(&#39;&lt;i2&#39;))
</pre></div>
</div>
</div>
</div>
<p>That’s not optimal. Our <code class="docutils literal notranslate"><span class="pre">data</span> <span class="pre">array</span></code> has the correct <code class="docutils literal notranslate"><span class="pre">type</span></code>, but the <code class="docutils literal notranslate"><span class="pre">on-disk</span> <span class="pre">format</span></code> is determined by the <code class="docutils literal notranslate"><span class="pre">header</span></code>, so <code class="docutils literal notranslate"><span class="pre">saving</span></code> it with <code class="docutils literal notranslate"><span class="pre">img.header</span></code> will not do what we want. Also, let’s take a look at the <code class="docutils literal notranslate"><span class="pre">size</span></code> of the <code class="docutils literal notranslate"><span class="pre">original</span></code> and <code class="docutils literal notranslate"><span class="pre">new</span></code> <code class="docutils literal notranslate"><span class="pre">file</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">orig_filename</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_filename</span><span class="p">()</span>
<span class="o">!</span>du -hL rescaled_image.nii.gz <span class="nv">$orig_filename</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 12M	rescaled_image.nii.gz
 24M	/data/ds000114/sub-01/ses-test/func/sub-01_ses-test_task-fingerfootlips_bold.nii.gz
</pre></div>
</div>
</div>
</div>
<p>So, let’s correct the <code class="docutils literal notranslate"><span class="pre">header</span></code> issue with the <code class="docutils literal notranslate"><span class="pre">set_data_dtype()</span></code> <code class="docutils literal notranslate"><span class="pre">function</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img</span><span class="o">.</span><span class="n">set_data_dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>and then saving <code class="docutils literal notranslate"><span class="pre">image</span></code> again:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_img</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">rescaled</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
<span class="n">nb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">new_img</span><span class="p">,</span> <span class="s1">&#39;rescaled_image.nii.gz&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>After which we evaluate our <code class="docutils literal notranslate"><span class="pre">image</span></code> again:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">((</span><span class="n">new_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">new_img</span><span class="o">.</span><span class="n">get_data_dtype</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(dtype(&#39;float64&#39;), dtype(&#39;uint8&#39;))
</pre></div>
</div>
</div>
</div>
<p>Perfect! Now the <code class="docutils literal notranslate"><span class="pre">data</span></code> <code class="docutils literal notranslate"><span class="pre">types</span></code> are correct. And if we look at the <code class="docutils literal notranslate"><span class="pre">size</span></code> of the <code class="docutils literal notranslate"><span class="pre">image</span></code> we even see that it got a bit smaller.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>du -hL rescaled_image.nii.gz
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 10M	rescaled_image.nii.gz
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="conclusions">
<h1>Conclusions<a class="headerlink" href="#conclusions" title="Permalink to this headline">¶</a></h1>
<p>In this first introduction of how to work with <code class="docutils literal notranslate"><span class="pre">neuroimaging</span> <span class="pre">data</span></code> using <code class="docutils literal notranslate"><span class="pre">python</span></code>, we’ve explored <code class="docutils literal notranslate"><span class="pre">load</span></code>ing, <code class="docutils literal notranslate"><span class="pre">saving</span></code> and <code class="docutils literal notranslate"><span class="pre">visualizing</span></code> <code class="docutils literal notranslate"><span class="pre">neuroimages</span></code> via <code class="docutils literal notranslate"><span class="pre">nibabel</span></code>, as well as how it can make some more sophisticated manipulations easy. At this point, you should be able to <code class="docutils literal notranslate"><span class="pre">inspect</span></code> and <code class="docutils literal notranslate"><span class="pre">plot</span></code> most <code class="docutils literal notranslate"><span class="pre">images</span></code> you encounter, as well as make modifications while preserving the <code class="docutils literal notranslate"><span class="pre">alignment</span></code> (at least for basic operations).</p>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./introduction/notebooks/neuroscience"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="mri_intro.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Magnetic Resonance Imaging (MRI)</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="morphometry.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Morphometric analyzes</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Peer Herholz<br/>
    
        &copy; Copyright 2022.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>